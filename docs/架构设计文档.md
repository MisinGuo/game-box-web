# 系统架构设计文档

> 版本：v1.0.0  
> 日期：2025-12-13  
> 项目：游戏盒子内容管理系统

---

## 1. 整体架构

### 1.1 技术栈选择

| 层级 | 技术选择 | 理由 |
|------|---------|------|
| 前端展示 | Next.js 14 + Cloudflare Workers | SSR/ISR，边缘计算，SEO 友好 |
| 管理后台 | 若依 Vue3 + Element Plus | 开箱即用的后台解决方案 |
| 后端服务 | 若依 Cloud (Spring Cloud) | 微服务架构，成熟的权限体系 |
| 数据库 | MySQL 8.0 | 关系型数据，事务支持 |
| 搜索引擎 | ElasticSearch 8.x | 全文搜索，中文分词 |
| 对象存储 | Cloudflare R2 | Markdown 文件存储 |
| 缓存 | Redis 6.x | 热点数据缓存 |
| 消息队列 | RabbitMQ | 异步任务处理 |

### 1.2 微服务架构

```mermaid
graph TB
    subgraph "接入层"
        A[Nginx 负载均衡]
        B[若依网关 Gateway]
    end
    
    subgraph "业务服务层"
        C[用户服务<br/>ruoyi-system]
        D[文档服务<br/>ruoyi-document]
        E[搜索服务<br/>ruoyi-search]
        F[游戏服务<br/>ruoyi-game]
        G[统计服务<br/>ruoyi-analytics]
        H[关联服务<br/>ruoyi-relation]
    end
    
    subgraph "基础服务层"
        I[配置中心<br/>Nacos]
        J[注册中心<br/>Nacos]
        K[监控中心<br/>Spring Admin]
    end
    
    subgraph "数据层"
        L[(MySQL 主库)]
        M[(MySQL 从库)]
        N[(Redis)]
        O[(ElasticSearch)]
        P[(Cloudflare R2)]
    end
    
    A --> B
    B --> C
    B --> D
    B --> E
    B --> F
    B --> G
    B --> H
    
    C --> I
    D --> I
    E --> I
    F --> I
    G --> I
    H --> I
    
    C --> J
    D --> J
    E --> J
    F --> J
    G --> J
    H --> J
    
    C --> L
    C --> M
    D --> L
    D --> P
    E --> O
    F --> L
    G --> L
    H --> L
    
    C -.缓存.-> N
    D -.缓存.-> N
    E -.缓存.-> N
    F -.缓存.-> N
```

---

## 2. 数据流架构

### 2.1 文档处理流程

```mermaid
sequenceDiagram
    participant Git as Git Repository
    participant Worker as Cloudflare Worker
    participant R2 as R2 Storage
    participant API as 后端 API
    participant ES as ElasticSearch
    participant DB as MySQL
    participant Cache as Redis
    
    Note over Git,Cache: 文档同步流程
    Git->>Worker: Webhook 触发
    Worker->>R2: 上传 Markdown 文件
    Worker->>API: 通知文档更新
    API->>R2: 读取文档内容
    API->>ES: 更新搜索索引
    API->>DB: 更新元数据
    API->>Cache: 清除相关缓存
    
    Note over Git,Cache: 用户访问流程
    Worker->>Cache: 检查页面缓存
    alt 缓存命中
        Cache->>Worker: 返回缓存内容
    else 缓存未命中
        Worker->>R2: 读取 Markdown
        Worker->>API: 获取关联数据
        API->>DB: 查询游戏信息
        API->>Worker: 返回数据
        Worker->>Cache: 存入缓存
    end
```

### 2.2 搜索流程

```mermaid
flowchart LR
    A[用户搜索] --> B{缓存检查}
    B -->|命中| C[返回缓存结果]
    B -->|未命中| D[ES 搜索]
    D --> E[结果处理]
    E --> F[写入缓存]
    E --> G[记录日志]
    F --> H[返回结果]
    G --> I[异步统计]
    
    style A fill:#e1f5ff
    style C fill:#e8f5e9
    style H fill:#e8f5e9
    style I fill:#fff4e6
```

---

## 3. 部署架构

### 3.3 云原生部署

```mermaid
graph TB
    subgraph "Cloudflare"
        A[Workers<br/>前端应用]
        B[R2<br/>对象存储]
        C[CDN<br/>静态资源]
    end
    
    subgraph "阿里云 / 腾讯云"
        D[负载均衡器<br/>SLB/CLB]
        
        subgraph "Kubernetes 集群"
            E[Gateway Pod]
            F[Business Pods]
            G[Monitor Pod]
        end
        
        subgraph "中间件"
            H[(MySQL RDS)]
            I[(Redis)]
            J[(ElasticSearch)]
            K[RabbitMQ]
        end
    end
    
    A --> D
    D --> E
    E --> F
    F --> H
    F --> I
    F --> J
    F --> K
    
    A -.读取文档.-> B
    A -.静态资源.-> C
```

### 3.4 监控体系

```mermaid
graph LR
    subgraph "数据采集"
        A[应用埋点<br/>Micrometer]
        B[基础监控<br/>Node Exporter]
        C[中间件监控<br/>各种 Exporter]
        D[日志采集<br/>Filebeat]
    end
    
    subgraph "数据处理"
        E[指标存储<br/>Prometheus]
        F[日志处理<br/>Logstash]
        G[日志存储<br/>ElasticSearch]
    end
    
    subgraph "可视化告警"
        H[监控面板<br/>Grafana]
        I[日志查询<br/>Kibana]
        J[告警通知<br/>AlertManager]
    end
    
    A --> E
    B --> E
    C --> E
    D --> F
    F --> G
    
    E --> H
    E --> J
    G --> I
```

---

## 4. 核心模块设计

### 4.1 文档服务架构

```mermaid
classDiagram
    class DocumentService {
        +uploadDocument(file)
        +syncToES(document)
        +getDocument(slug)
        +updateMetadata(slug, meta)
        +deleteDocument(slug)
    }
    
    class DocumentParser {
        +parseMarkdown(content)
        +extractMeta(frontmatter)
        +generatePreview(content)
        +extractKeywords(content)
    }
    
    class StorageAdapter {
        +upload(key, content)
        +download(key)
        +delete(key)
        +exists(key)
    }
    
    class SearchIndexer {
        +indexDocument(doc)
        +updateIndex(id, doc)
        +deleteIndex(id)
        +bulkIndex(docs)
    }
    
    DocumentService --> DocumentParser
    DocumentService --> StorageAdapter
    DocumentService --> SearchIndexer
```

### 4.2 搜索服务架构

```mermaid
classDiagram
    class SearchService {
        +search(query, filters)
        +suggest(prefix)
        +getHotKeywords()
        +recordSearchLog(query, results)
    }
    
    class QueryBuilder {
        +buildBoolQuery(query)
        +addFilters(filters)
        +addHighlight()
        +addAggregations()
    }
    
    class ResultProcessor {
        +processHits(hits)
        +extractHighlights()
        +buildSuggestions()
        +calculateScore()
    }
    
    class SearchCache {
        +get(key)
        +set(key, value, ttl)
        +delete(pattern)
        +clear()
    }
    
    SearchService --> QueryBuilder
    SearchService --> ResultProcessor
    SearchService --> SearchCache
```

### 4.3 智能关联设计

```mermaid
graph TD
    A[文档上传] --> B[内容分析]
    B --> C[关键词提取]
    B --> D[分类识别]
    B --> E[标签生成]
    
    C --> F[相似度计算]
    D --> F
    E --> F
    
    F --> G[游戏匹配]
    G --> H[关联规则引擎]
    H --> I[关联度评分]
    I --> J{评分 > 阈值?}
    
    J -->|Yes| K[自动关联]
    J -->|No| L[待人工审核]
    
    K --> M[关联生效]
    L --> N[人工确认]
    N --> M
```

---

## 5. 性能优化策略

### 5.1 缓存策略

| 缓存层级 | 缓存内容 | TTL | 更新策略 |
|---------|---------|-----|---------|
| CDN 缓存 | 静态文件、图片 | 24h | 版本号更新 |
| Workers 缓存 | 热门文章页面 | 1h | 主动刷新 |
| Redis 缓存 | 搜索结果、API 响应 | 30min | LRU 淘汰 |
| 应用缓存 | 配置信息、用户会话 | 15min | 定时刷新 |

### 5.2 数据库优化

```mermaid
erDiagram
    DOCUMENTS {
        bigint id PK
        varchar slug UK
        varchar title
        varchar category
        text content_preview
        datetime created_at
        datetime updated_at
        int views
    }
    
    GAMES {
        bigint id PK
        varchar name
        varchar category
        varchar download_url
        int download_count
        datetime created_at
    }
    
    DOCUMENT_GAME_RELATIONS {
        bigint id PK
        bigint document_id FK
        bigint game_id FK
        decimal relevance_score
        varchar relation_type
        datetime created_at
    }
    
    SEARCH_LOGS {
        bigint id PK
        varchar query
        int result_count
        float search_time_ms
        datetime search_at
        varchar user_ip
    }
    
    DOCUMENTS ||--o{ DOCUMENT_GAME_RELATIONS : "has"
    GAMES ||--o{ DOCUMENT_GAME_RELATIONS : "relates"
```

### 5.3 搜索性能优化

| 优化点 | 策略 | 预期效果 |
|-------|------|---------|
| 索引设计 | 分片数量优化、字段类型优化 | 响应时间 < 100ms |
| 查询优化 | 布尔查询、过滤器缓存 | QPS 提升 50% |
| 结果缓存 | Redis 缓存热门查询 | 缓存命中率 > 80% |
| 异步更新 | 消息队列处理索引更新 | 写入性能提升 3x |

---

## 6. 安全架构

### 6.1 安全防护体系

```mermaid
graph TB
    subgraph "网络安全"
        A[CDN 防护<br/>DDoS/CC 攻击]
        B[WAF 防火墙<br/>SQL 注入/XSS]
        C[负载均衡<br/>流量分发]
    end
    
    subgraph "应用安全"
        D[API 网关<br/>鉴权/限流]
        E[JWT Token<br/>身份认证]
        F[权限控制<br/>RBAC 模型]
    end
    
    subgraph "数据安全"
        G[数据库加密<br/>敏感字段]
        H[备份策略<br/>异地多活]
        I[操作审计<br/>行为记录]
    end
    
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
```

### 6.2 权限模型

```mermaid
erDiagram
    USER {
        bigint id PK
        varchar username
        varchar email
        varchar password_hash
        datetime created_at
        tinyint status
    }
    
    ROLE {
        bigint id PK
        varchar role_name
        varchar description
        tinyint status
    }
    
    PERMISSION {
        bigint id PK
        varchar permission_name
        varchar resource
        varchar action
    }
    
    USER_ROLE {
        bigint user_id FK
        bigint role_id FK
    }
    
    ROLE_PERMISSION {
        bigint role_id FK
        bigint permission_id FK
    }
    
    USER ||--o{ USER_ROLE : "has"
    ROLE ||--o{ USER_ROLE : "belongs"
    ROLE ||--o{ ROLE_PERMISSION : "has"
    PERMISSION ||--o{ ROLE_PERMISSION : "grants"
```

---

## 附录

### A.1 服务端口规划

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| Gateway | 8080 | HTTP | API 网关 |
| System | 9201 | HTTP | 用户服务 |
| Document | 9202 | HTTP | 文档服务 |
| Search | 9203 | HTTP | 搜索服务 |
| Game | 9204 | HTTP | 游戏服务 |
| Analytics | 9205 | HTTP | 统计服务 |
| Redis | 6379 | TCP | 缓存 |
| MySQL | 3306 | TCP | 数据库 |
| ElasticSearch | 9200 | HTTP | 搜索引擎 |

### A.2 环境配置

| 环境 | 域名 | 说明 |
|------|------|------|
| 开发环境 | dev.gamebox.local | 本地开发 |
| 测试环境 | test.gamebox.com | 功能测试 |
| 预发环境 | staging.gamebox.com | 性能测试 |
| 生产环境 | www.gamebox.com | 正式环境 |