# ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv2.7.0  
> æ—¥æœŸï¼š2025-12-14  
> é¡¹ç›®ï¼šå¤šäº§å“å†…å®¹ç®¡ç†ç³»ç»Ÿï¼ˆæ¸¸æˆç›’å­ / çŸ­å‰§æ¨å¹¿ï¼‰

---

## 1. æ•´ä½“æ¶æ„

### 1.1 ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿé‡‡ç”¨**ç»Ÿä¸€ç®¡ç†åå° + å¤šç«™ç‚¹è¾¹ç¼˜å‰ç«¯**çš„æ¶æ„æ¨¡å¼ï¼š

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| **æ¨å¹¿ç«™ç‚¹**ï¼ˆå¤šä¸ªï¼‰ | éƒ¨ç½²åœ¨ Cloudflare è¾¹ç¼˜ç½‘ç»œï¼Œåˆ†åˆ«ç”¨äºæ¸¸æˆæ¨å¹¿ã€çŸ­å‰§æ¨å¹¿ç­‰ï¼Œå±•ç¤ºå†…å®¹å¹¶æä¾›ä¸‹è½½è½åœ° |
| **ç®¡ç†åå°**ï¼ˆå•ä¸€ï¼‰ | ç»Ÿä¸€å¹³å°ç®¡ç†æ‰€æœ‰ç«™ç‚¹å†…å®¹ï¼Œé€šè¿‡ AI ç”Ÿæˆæ¸¸æˆ/çŸ­å‰§ç›¸å…³æ–‡ç« å¹¶å‘å¸ƒ |
| **åç«¯æœåŠ¡** | è‹¥ä¾ Boot å•ä½“åº”ç”¨ï¼Œä¸ºæ¨å¹¿ç«™ç‚¹å’Œç®¡ç†åå°æä¾› API æ¥å£ |

```mermaid
graph TB
    subgraph "è¾¹ç¼˜ç½‘ç»œ - å¤šæ¨å¹¿ç«™ç‚¹"
        W1[æ¸¸æˆæ¨å¹¿ç«™ A<br/>Next.js + Cloudflare Workers]
        W2[æ¸¸æˆæ¨å¹¿ç«™ B<br/>Next.js + Cloudflare Workers]
        W3[çŸ­å‰§æ¨å¹¿ç«™<br/>Next.js + Cloudflare Workers]
    end
    
    subgraph "ç»Ÿä¸€ç®¡ç†å¹³å°"
        Admin[ç®¡ç†åå°<br/>Vue3 + Element Plus]
        Backend[è‹¥ä¾ Boot åç«¯<br/>ruoyi-admin]
    end
    
    subgraph "æ•°æ®å­˜å‚¨"
        DB[(MySQL)]
        Cache[(Redis)]
        ES[(ElasticSearch)]
        R2[(R2 å¯¹è±¡å­˜å‚¨)]
    end
    
    subgraph "AI ç”ŸæˆæœåŠ¡"
        GitHub[GitHub Actions]
        AI[AI å¹³å°]
    end
    
    W1 -->|API è°ƒç”¨| Backend
    W2 -->|API è°ƒç”¨| Backend
    W3 -->|API è°ƒç”¨| Backend
    Admin -->|ç®¡ç†æ“ä½œ| Backend
    
    Backend --> DB
    Backend --> Cache
    Backend --> ES
    Backend --> R2
    
    Backend -.è§¦å‘.-> GitHub
    GitHub --> AI
    GitHub -.å›è°ƒ.-> Backend
```

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

| å±‚çº§ | æŠ€æœ¯é€‰æ‹© | ç†ç”± |
|------|---------|------|
| **æ¨å¹¿ç«™ç‚¹** | Next.js 14 + Cloudflare Workers | SSR/ISRï¼Œè¾¹ç¼˜è®¡ç®—ï¼ŒSEO å‹å¥½ï¼Œå¤šç«™ç‚¹å¤ç”¨ |
| **ç®¡ç†åå°** | è‹¥ä¾ Vue3 + Element Plus | å¼€ç®±å³ç”¨çš„åå°è§£å†³æ–¹æ¡ˆ |
| **åç«¯æœåŠ¡** | è‹¥ä¾ Boot (Spring Boot 3.x) | å•ä½“æ¶æ„ï¼Œéƒ¨ç½²ç®€å•ï¼Œæˆç†Ÿçš„æƒé™ä½“ç³» |
| **æ•°æ®åº“** | MySQL 8.0 | å…³ç³»å‹æ•°æ®ï¼Œäº‹åŠ¡æ”¯æŒ |
| **æœç´¢å¼•æ“** | ElasticSearch 8.x | å…¨æ–‡æœç´¢ï¼Œä¸­æ–‡åˆ†è¯ |
| **å¯¹è±¡å­˜å‚¨** | Cloudflare R2 / å¤šå­˜å‚¨æ”¯æŒ | Markdown æ–‡ä»¶åŠèµ„æºå­˜å‚¨ |
| **ç¼“å­˜** | Redis 6.x | çƒ­ç‚¹æ•°æ®ç¼“å­˜ |
| **ä»»åŠ¡è°ƒåº¦** | Spring Scheduler | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| **AI æ–‡ç« ç”Ÿæˆ** | GitHub Actions | è‡ªåŠ¨åŒ–å†…å®¹ç”Ÿæˆï¼Œå¯å¤ç”¨å…¬å…± Action |

### 1.3 åç«¯æ¨¡å—æ¶æ„

```mermaid
graph TB
    subgraph "æ¥å…¥å±‚"
        A[Nginx è´Ÿè½½å‡è¡¡]
    end
    
    subgraph "åº”ç”¨å±‚"
        B[è‹¥ä¾ Boot å•ä½“åº”ç”¨<br/>ruoyi-admin]
        
        subgraph "ä¸šåŠ¡æ¨¡å—"
            C[ç³»ç»Ÿæ¨¡å—<br/>system]
            D[æ–‡æ¡£æ¨¡å—<br/>document]
            E[æœç´¢æ¨¡å—<br/>search]
            F[æ¸¸æˆæ¨¡å—<br/>game]
            G[ç»Ÿè®¡æ¨¡å—<br/>analytics]
            H[å…³è”æ¨¡å—<br/>relation]
            I2[AIç”Ÿæˆæ¨¡å—<br/>ai]
            J2[èµ„æºæ¨¡å—<br/>resource]
            K2[çŸ­å‰§æ¨¡å—<br/>drama]
            L2[ç½‘ç«™æ¨¡å—<br/>site]
        end
    end
    
    subgraph "æ•°æ®å±‚"
        L[(MySQL)]
        N[(Redis)]
        O[(ElasticSearch)]
        P[(å¯¹è±¡å­˜å‚¨<br/>R2/OSS/COS)]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        Q[GitHub Actions]
        R[AI å¹³å°<br/>OpenAI/Claude/DeepSeek]
        S[å›¾ç‰‡æœç´¢<br/>Unsplash/Pixabay]
    end
    
    A --> B
    
    B --> C
    B --> D
    B --> E
    B --> F
    B --> G
    B --> H
    B --> I2
    B --> J2
    B --> K2
    B --> L2
    
    C --> L
    D --> L
    D --> P
    E --> O
    F --> L
    G --> L
    H --> L
    I2 --> L
    J2 --> L
    J2 --> P
    K2 --> L
    L2 --> L
    
    I2 -.è§¦å‘workflow.-> Q
    Q -.å›è°ƒ.-> I2
    Q --> R
    Q --> S
    
    C -.ç¼“å­˜.-> N
    D -.ç¼“å­˜.-> N
    E -.ç¼“å­˜.-> N
    F -.ç¼“å­˜.-> N
    I2 -.ç¼“å­˜.-> N
    J2 -.ç¼“å­˜.-> N
```

### 1.4 æ¨å¹¿ç«™ç‚¹æ•°æ®æµ

æ¨å¹¿ç«™ç‚¹ï¼ˆå¦‚æ¸¸æˆæ¨å¹¿ç«™ï¼‰é€šè¿‡è°ƒç”¨åç«¯ API è·å–æ•°æ®ï¼š

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Site as æ¨å¹¿ç«™ç‚¹<br/>(è¾¹ç¼˜)
    participant API as åç«¯ API
    participant Cache as Redis
    participant DB as MySQL
    
    User->>Site: è®¿é—®æ¸¸æˆè¯¦æƒ…é¡µ
    Site->>API: GET /api/game/{id}
    API->>Cache: æŸ¥è¯¢ç¼“å­˜
    
    alt ç¼“å­˜å‘½ä¸­
        Cache->>API: è¿”å›æ•°æ®
    else ç¼“å­˜æœªå‘½ä¸­
        API->>DB: æŸ¥è¯¢æ•°æ®åº“
        DB->>API: è¿”å›æ•°æ®
        API->>Cache: å†™å…¥ç¼“å­˜
    end
    
    API->>Site: è¿”å›æ¸¸æˆæ•°æ®
    Site->>Site: SSR æ¸²æŸ“é¡µé¢
    Site->>User: è¿”å› HTML
    
    User->>Site: ç‚¹å‡»"ä¸‹è½½æ¸¸æˆç›’å­"
    Site->>API: GET /api/gamebox/{id}
    API->>Site: è¿”å›æ¸¸æˆç›’å­ä¿¡æ¯
    Site->>User: è·³è½¬ä¸‹è½½é¡µ
```

---

## 2. æ•°æ®æµæ¶æ„

### 2.1 æ–‡æ¡£å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant Git as Git Repository
    participant Worker as Cloudflare Worker
    participant R2 as R2 Storage
    participant API as åç«¯ API
    participant ES as ElasticSearch
    participant DB as MySQL
    participant Cache as Redis
    
    Note over Git,Cache: æ–‡æ¡£åŒæ­¥æµç¨‹
    Git->>Worker: Webhook è§¦å‘
    Worker->>R2: ä¸Šä¼  Markdown æ–‡ä»¶
    Worker->>API: é€šçŸ¥æ–‡æ¡£æ›´æ–°
    API->>R2: è¯»å–æ–‡æ¡£å†…å®¹
    API->>ES: æ›´æ–°æœç´¢ç´¢å¼•
    API->>DB: æ›´æ–°å…ƒæ•°æ®
    API->>Cache: æ¸…é™¤ç›¸å…³ç¼“å­˜
    
    Note over Git,Cache: ç”¨æˆ·è®¿é—®æµç¨‹
    Worker->>Cache: æ£€æŸ¥é¡µé¢ç¼“å­˜
    alt ç¼“å­˜å‘½ä¸­
        Cache->>Worker: è¿”å›ç¼“å­˜å†…å®¹
    else ç¼“å­˜æœªå‘½ä¸­
        Worker->>R2: è¯»å– Markdown
        Worker->>API: è·å–å…³è”æ•°æ®
        API->>DB: æŸ¥è¯¢æ¸¸æˆä¿¡æ¯
        API->>Worker: è¿”å›æ•°æ®
        Worker->>Cache: å­˜å…¥ç¼“å­˜
    end
```

### 2.2 æœç´¢æµç¨‹

```mermaid
flowchart LR
    A[ç”¨æˆ·æœç´¢] --> B{ç¼“å­˜æ£€æŸ¥}
    B -->|å‘½ä¸­| C[è¿”å›ç¼“å­˜ç»“æœ]
    B -->|æœªå‘½ä¸­| D[ES æœç´¢]
    D --> E[ç»“æœå¤„ç†]
    E --> F[å†™å…¥ç¼“å­˜]
    E --> G[è®°å½•æ—¥å¿—]
    F --> H[è¿”å›ç»“æœ]
    G --> I[å¼‚æ­¥ç»Ÿè®¡]
    
    style A fill:#e1f5ff
    style C fill:#e8f5e9
    style H fill:#e8f5e9
    style I fill:#fff4e6
```

---

## 3. éƒ¨ç½²æ¶æ„

### 3.1 å•ä½“åº”ç”¨éƒ¨ç½²

```mermaid
graph TB
    subgraph "Cloudflare"
        A[Workers<br/>å‰ç«¯åº”ç”¨]
        B[R2<br/>å¯¹è±¡å­˜å‚¨]
        C[CDN<br/>é™æ€èµ„æº]
    end
    
    subgraph "äº‘æœåŠ¡å™¨"
        D[Nginx<br/>åå‘ä»£ç†]
        E[è‹¥ä¾ Boot<br/>Spring Boot åº”ç”¨]
        
        subgraph "ä¸­é—´ä»¶"
            H[(MySQL)]
            I[(Redis)]
            J[(ElasticSearch)]
        end
    end
    
    A --> D
    D --> E
    E --> H
    E --> I
    E --> J
    E -.å­˜å‚¨.-> B
    
    A -.è¯»å–æ–‡æ¡£.-> B
    A -.é™æ€èµ„æº.-> C
```

### 3.4 ç›‘æ§ä½“ç³»

```mermaid
graph LR
    subgraph "æ•°æ®é‡‡é›†"
        A[åº”ç”¨åŸ‹ç‚¹<br/>Micrometer]
        B[åŸºç¡€ç›‘æ§<br/>Node Exporter]
        C[ä¸­é—´ä»¶ç›‘æ§<br/>å„ç§ Exporter]
        D[æ—¥å¿—é‡‡é›†<br/>Filebeat]
    end
    
    subgraph "æ•°æ®å¤„ç†"
        E[æŒ‡æ ‡å­˜å‚¨<br/>Prometheus]
        F[æ—¥å¿—å¤„ç†<br/>Logstash]
        G[æ—¥å¿—å­˜å‚¨<br/>ElasticSearch]
    end
    
    subgraph "å¯è§†åŒ–å‘Šè­¦"
        H[ç›‘æ§é¢æ¿<br/>Grafana]
        I[æ—¥å¿—æŸ¥è¯¢<br/>Kibana]
        J[å‘Šè­¦é€šçŸ¥<br/>AlertManager]
    end
    
    A --> E
    B --> E
    C --> E
    D --> F
    F --> G
    
    E --> H
    E --> J
    G --> I
```

---

## 4. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 4.1 æ–‡æ¡£æœåŠ¡æ¶æ„

```mermaid
classDiagram
    class DocumentService {
        +uploadDocument(file)
        +syncToES(document)
        +getDocument(slug)
        +updateMetadata(slug, meta)
        +deleteDocument(slug)
    }
    
    class DocumentParser {
        +parseMarkdown(content)
        +extractMeta(frontmatter)
        +generatePreview(content)
        +extractKeywords(content)
    }
    
    class StorageAdapter {
        +upload(key, content)
        +download(key)
        +delete(key)
        +exists(key)
    }
    
    class SearchIndexer {
        +indexDocument(doc)
        +updateIndex(id, doc)
        +deleteIndex(id)
        +bulkIndex(docs)
    }
    
    DocumentService --> DocumentParser
    DocumentService --> StorageAdapter
    DocumentService --> SearchIndexer
```

### 4.2 æœç´¢æœåŠ¡æ¶æ„

```mermaid
classDiagram
    class SearchService {
        +search(query, filters)
        +suggest(prefix)
        +getHotKeywords()
        +recordSearchLog(query, results)
    }
    
    class QueryBuilder {
        +buildBoolQuery(query)
        +addFilters(filters)
        +addHighlight()
        +addAggregations()
    }
    
    class ResultProcessor {
        +processHits(hits)
        +extractHighlights()
        +buildSuggestions()
        +calculateScore()
    }
    
    class SearchCache {
        +get(key)
        +set(key, value, ttl)
        +delete(pattern)
        +clear()
    }
    
    SearchService --> QueryBuilder
    SearchService --> ResultProcessor
    SearchService --> SearchCache
```

### 4.3 æ™ºèƒ½å…³è”è®¾è®¡

```mermaid
graph TD
    A[æ–‡æ¡£ä¸Šä¼ ] --> B[å†…å®¹åˆ†æ]
    B --> C[å…³é”®è¯æå–]
    B --> D[åˆ†ç±»è¯†åˆ«]
    B --> E[æ ‡ç­¾ç”Ÿæˆ]
    
    C --> F[ç›¸ä¼¼åº¦è®¡ç®—]
    D --> F
    E --> F
    
    F --> G[æ¸¸æˆåŒ¹é…]
    G --> H[å…³è”è§„åˆ™å¼•æ“]
    H --> I[å…³è”åº¦è¯„åˆ†]
    I --> J{è¯„åˆ† > é˜ˆå€¼?}
    
    J -->|Yes| K[è‡ªåŠ¨å…³è”]
    J -->|No| L[å¾…äººå·¥å®¡æ ¸]
    
    K --> M[å…³è”ç”Ÿæ•ˆ]
    L --> N[äººå·¥ç¡®è®¤]
    N --> M
```

### 4.4 AIæ–‡ç« ç”ŸæˆæœåŠ¡æ¶æ„

```mermaid
classDiagram
    class ArticleGenerationService {
        +generateArticle(templateId, variables)
        +regenerateArticle(articleId)
        +batchGenerate(tasks)
        +getGenerationHistory(articleId)
    }
    
    class PromptTemplateService {
        +getTemplate(id)
        +renderPrompt(template, variables)
        +validateVariables(template, variables)
        +listTemplates(type, siteId)
    }
    
    class AIProviderAdapter {
        +callOpenAI(prompt)
        +callClaude(prompt)
        +callQwen(prompt)
        +callDeepSeek(prompt)
    }
    
    class GenerationTaskQueue {
        +enqueue(task)
        +process()
        +retry(taskId)
        +getStatus(taskId)
    }
    
    ArticleGenerationService --> PromptTemplateService
    ArticleGenerationService --> AIProviderAdapter
    ArticleGenerationService --> GenerationTaskQueue
```

### 4.5 èµ„æºç®¡ç†æœåŠ¡æ¶æ„

```mermaid
classDiagram
    class ResourceService {
        +uploadResource(file, config)
        +getResource(id)
        +deleteResource(id)
        +listResources(articleId)
    }
    
    class StorageMigrationService {
        +createRule(rule)
        +executeRule(ruleId, options)
        +getMigrationStatus(taskId)
        +rollbackMigration(logId)
    }
    
    class StorageAdapterFactory {
        +getAdapter(storageType)
        +uploadToStorage(config, file)
        +downloadFromStorage(config, path)
        +copyBetweenStorages(source, target, path)
    }
    
    class MigrationWorker {
        +processTask(task)
        +updateResourceUrl(resourceId, newUrl)
        +logMigration(log)
        +handleFailure(task, error)
    }
    
    ResourceService --> StorageAdapterFactory
    StorageMigrationService --> StorageAdapterFactory
    StorageMigrationService --> MigrationWorker
```

### 4.6 èµ„æºè¿ç§»æµç¨‹

```mermaid
graph TD
    A[åˆ›å»ºè¿ç§»è§„åˆ™] --> B[é…ç½®æº/ç›®æ ‡å­˜å‚¨]
    B --> C[è®¾ç½®URLåŒ¹é…æ¨¡å¼]
    C --> D[é€‰æ‹©è¿ç§»èŒƒå›´]
    D --> E{è¯•è¿è¡Œ?}
    
    E -->|Yes| F[é¢„è§ˆåŒ¹é…ç»“æœ]
    F --> G{ç¡®è®¤æ‰§è¡Œ?}
    G -->|No| D
    G -->|Yes| H[å¼€å§‹è¿ç§»]
    
    E -->|No| H
    
    H --> I[éå†åŒ¹é…èµ„æº]
    I --> J[ä¸‹è½½æºæ–‡ä»¶]
    J --> K[ä¸Šä¼ åˆ°ç›®æ ‡å­˜å‚¨]
    K --> L[æ›´æ–°èµ„æºURL]
    L --> M[è®°å½•è¿ç§»æ—¥å¿—]
    M --> N{è¿˜æœ‰æ›´å¤š?}
    
    N -->|Yes| I
    N -->|No| O[è¿ç§»å®Œæˆ]
    
    style A fill:#e1f5ff
    style O fill:#e8f5e9
```

---

## 5. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 5.1 ç¼“å­˜ç­–ç•¥

| ç¼“å­˜å±‚çº§ | ç¼“å­˜å†…å®¹ | TTL | æ›´æ–°ç­–ç•¥ |
|---------|---------|-----|---------|
| CDN ç¼“å­˜ | é™æ€æ–‡ä»¶ã€å›¾ç‰‡ | 24h | ç‰ˆæœ¬å·æ›´æ–° |
| Workers ç¼“å­˜ | çƒ­é—¨æ–‡ç« é¡µé¢ | 1h | ä¸»åŠ¨åˆ·æ–° |
| Redis ç¼“å­˜ | æœç´¢ç»“æœã€API å“åº” | 30min | LRU æ·˜æ±° |
| åº”ç”¨ç¼“å­˜ | é…ç½®ä¿¡æ¯ã€ç”¨æˆ·ä¼šè¯ | 15min | å®šæ—¶åˆ·æ–° |

### 5.2 æ•°æ®åº“ä¼˜åŒ–

```mermaid
erDiagram
    DOCUMENTS {
        bigint id PK
        varchar slug UK
        varchar title
        varchar category
        text content_preview
        datetime created_at
        datetime updated_at
        int views
    }
    
    GAMES {
        bigint id PK
        varchar name
        varchar category
        varchar download_url
        int download_count
        datetime created_at
    }
    
    DOCUMENT_GAME_RELATIONS {
        bigint id PK
        bigint document_id FK
        bigint game_id FK
        decimal relevance_score
        varchar relation_type
        datetime created_at
    }
    
    SEARCH_LOGS {
        bigint id PK
        varchar query
        int result_count
        float search_time_ms
        datetime search_at
        varchar user_ip
    }
    
    DOCUMENTS ||--o{ DOCUMENT_GAME_RELATIONS : "has"
    GAMES ||--o{ DOCUMENT_GAME_RELATIONS : "relates"
```

### 5.3 æœç´¢æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–ç‚¹ | ç­–ç•¥ | é¢„æœŸæ•ˆæœ |
|-------|------|---------|
| ç´¢å¼•è®¾è®¡ | åˆ†ç‰‡æ•°é‡ä¼˜åŒ–ã€å­—æ®µç±»å‹ä¼˜åŒ– | å“åº”æ—¶é—´ < 100ms |
| æŸ¥è¯¢ä¼˜åŒ– | å¸ƒå°”æŸ¥è¯¢ã€è¿‡æ»¤å™¨ç¼“å­˜ | QPS æå‡ 50% |
| ç»“æœç¼“å­˜ | Redis ç¼“å­˜çƒ­é—¨æŸ¥è¯¢ | ç¼“å­˜å‘½ä¸­ç‡ > 80% |
| å¼‚æ­¥æ›´æ–° | æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†ç´¢å¼•æ›´æ–° | å†™å…¥æ€§èƒ½æå‡ 3x |

---

## 6. å®‰å…¨æ¶æ„

### 6.1 å®‰å…¨é˜²æŠ¤ä½“ç³»

```mermaid
graph TB
    subgraph "ç½‘ç»œå®‰å…¨"
        A[CDN é˜²æŠ¤<br/>DDoS/CC æ”»å‡»]
        B[WAF é˜²ç«å¢™<br/>SQL æ³¨å…¥/XSS]
        C[è´Ÿè½½å‡è¡¡<br/>æµé‡åˆ†å‘]
    end
    
    subgraph "åº”ç”¨å®‰å…¨"
        D[API ç½‘å…³<br/>é‰´æƒ/é™æµ]
        E[JWT Token<br/>èº«ä»½è®¤è¯]
        F[æƒé™æ§åˆ¶<br/>RBAC æ¨¡å‹]
    end
    
    subgraph "æ•°æ®å®‰å…¨"
        G[æ•°æ®åº“åŠ å¯†<br/>æ•æ„Ÿå­—æ®µ]
        H[å¤‡ä»½ç­–ç•¥<br/>å¼‚åœ°å¤šæ´»]
        I[æ“ä½œå®¡è®¡<br/>è¡Œä¸ºè®°å½•]
    end
    
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
```

### 6.2 æƒé™æ¨¡å‹

```mermaid
erDiagram
    USER {
        bigint id PK
        varchar username
        varchar email
        varchar password_hash
        datetime created_at
        tinyint status
    }
    
    ROLE {
        bigint id PK
        varchar role_name
        varchar description
        tinyint status
    }
    
    PERMISSION {
        bigint id PK
        varchar permission_name
        varchar resource
        varchar action
    }
    
    USER_ROLE {
        bigint user_id FK
        bigint role_id FK
    }
    
    ROLE_PERMISSION {
        bigint role_id FK
        bigint permission_id FK
    }
    
    USER ||--o{ USER_ROLE : "has"
    ROLE ||--o{ USER_ROLE : "belongs"
    ROLE ||--o{ ROLE_PERMISSION : "has"
    PERMISSION ||--o{ ROLE_PERMISSION : "grants"
```

---

## é™„å½•

### A.1 æœåŠ¡ç«¯å£è§„åˆ’

| æœåŠ¡ | ç«¯å£ | åè®® | è¯´æ˜ |
|------|------|------|------|
| Nginx | 80/443 | HTTP/HTTPS | åå‘ä»£ç† |
| RuoYi-Admin | 8080 | HTTP | åç«¯åº”ç”¨ |
| Redis | 6379 | TCP | ç¼“å­˜ |
| MySQL | 3306 | TCP | æ•°æ®åº“ |
| ElasticSearch | 9200 | HTTP | æœç´¢å¼•æ“ |

### A.2 ç¯å¢ƒé…ç½®

| ç¯å¢ƒ | åŸŸå | è¯´æ˜ |
|------|------|------|
| å¼€å‘ç¯å¢ƒ | dev.gamebox.local | æœ¬åœ°å¼€å‘ |
| æµ‹è¯•ç¯å¢ƒ | test.gamebox.com | åŠŸèƒ½æµ‹è¯• |
| é¢„å‘ç¯å¢ƒ | staging.gamebox.com | æ€§èƒ½æµ‹è¯• |
| ç”Ÿäº§ç¯å¢ƒ | www.gamebox.com | æ­£å¼ç¯å¢ƒ |

### A.3 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ |
|------|------|---------|
| v1.0.0 | 2025-12-13 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€æ¶æ„è®¾è®¡ |
| v2.2.0 | 2025-12-14 | æ–°å¢AIç”ŸæˆæœåŠ¡ã€èµ„æºæœåŠ¡ã€çŸ­å‰§æœåŠ¡æ¶æ„ï¼›å®Œå–„å­˜å‚¨è¿ç§»æµç¨‹è®¾è®¡ |
| v2.3.0 | 2025-12-14 | æ¶æ„é™çº§ï¼šä»å¾®æœåŠ¡æ”¹ä¸ºå•ä½“æ¶æ„ï¼Œç®€åŒ–éƒ¨ç½²å¤æ‚åº¦ |
| v2.4.0 | 2025-12-14 | æ–°å¢ GitHub Action AI æ–‡ç« ç”Ÿæˆæ¶æ„è®¾è®¡ |

---

## 7. GitHub Action AI æ–‡ç« ç”Ÿæˆæ¶æ„

> ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼šç”¨æˆ·åœ¨ç®¡ç†åå°è¿æ¥å…¬å…± AI ç”Ÿæˆä»“åº“ï¼Œé…ç½® API Key å’Œå›¾ç‰‡æœåŠ¡ï¼Œç³»ç»Ÿé€šè¿‡å®šæ—¶ä»»åŠ¡è‡ªåŠ¨è§¦å‘ GitHub Action æ‰§è¡Œæ–‡ç« ç”Ÿæˆå’Œå‘å¸ƒã€‚

### 7.1 ç³»ç»Ÿé›†æˆæ¶æ„

```mermaid
graph TB
    subgraph "ç®¡ç†åå°"
        A[GitHub è´¦å·è¿æ¥]
        B[API Key é…ç½®]
        C[æ¨¡æ¿ç®¡ç†]
        D[å›¾ç‰‡æ± ç®¡ç†]
        E[å®šæ—¶ä»»åŠ¡é…ç½®]
    end
    
    subgraph "åç«¯æœåŠ¡"
        F[GitHub OAuth æœåŠ¡]
        G[Secrets åŒæ­¥æœåŠ¡]
        H[å®šæ—¶è°ƒåº¦å™¨]
        I[Webhook æ¥æ”¶å™¨]
        J[å›¾ç‰‡æ± æœåŠ¡]
    end
    
    subgraph "GitHub"
        K[ç”¨æˆ· Fork ä»“åº“]
        L[ä»“åº“ Secrets]
        M[GitHub Action]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        N[AI å¹³å°<br/>OpenAI/Claude/DeepSeek]
        O[å›¾ç‰‡æœç´¢<br/>Bing/Unsplash/Pixabay]
        P[å¯¹è±¡å­˜å‚¨<br/>R2/OSS/COS]
    end
    
    A --> F
    F --> K
    B --> G
    G --> L
    C --> K
    D --> J
    E --> H
    
    H -->|è§¦å‘ workflow_dispatch| M
    M --> N
    M --> O
    M --> P
    M -->|Webhook å›è°ƒ| I
    
    style A fill:#e1f5ff
    style M fill:#fff4e6
    style N fill:#e8f5e9
```

### 7.2 å®Œæ•´æ‰§è¡Œæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Admin as ç®¡ç†åå°
    participant Backend as åç«¯æœåŠ¡
    participant GitHub as GitHub API
    participant Action as GitHub Action
    participant AI as AI å¹³å°
    participant ImageAPI as å›¾ç‰‡æœç´¢ API
    participant Storage as å¯¹è±¡å­˜å‚¨

    Note over User,Storage: ä¸€æ¬¡æ€§é…ç½®é˜¶æ®µ
    User->>Admin: 1. ç™»å½•å¹¶æˆæƒ GitHub
    Admin->>GitHub: OAuth è®¤è¯
    GitHub-->>Admin: è¿”å› Access Token
    Admin->>Backend: ä¿å­˜ Token
    
    User->>Admin: 2. Fork å…¬å…±ä»“åº“
    Admin->>Backend: è¯·æ±‚ Fork
    Backend->>GitHub: POST /repos/:owner/:repo/forks
    GitHub-->>Backend: Fork æˆåŠŸ
    
    User->>Admin: 3. é…ç½® AI API Key
    Admin->>Backend: åŠ å¯†ä¿å­˜
    Backend->>GitHub: PUT /repos/:repo/actions/secrets
    
    User->>Admin: 4. é…ç½®å›¾ç‰‡æœåŠ¡
    Admin->>Backend: ä¿å­˜å›¾ç‰‡æœç´¢ API Key
    Backend->>GitHub: è®¾ç½® IMAGE_SEARCH_API_KEY Secret
    
    User->>Admin: 5. ä¸Šä¼ å›¾ç‰‡æ± 
    Admin->>Backend: ä¸Šä¼ å›¾ç‰‡/é…ç½®
    Backend->>Storage: ä¿å­˜å›¾ç‰‡æ±  JSON
    
    User->>Admin: 6. é…ç½®å®šæ—¶ä»»åŠ¡
    Admin->>Backend: ä¿å­˜ Cron è¡¨è¾¾å¼
    
    Note over User,Storage: æ¯æ—¥è‡ªåŠ¨æ‰§è¡Œé˜¶æ®µ
    Backend->>Backend: å®šæ—¶ä»»åŠ¡è§¦å‘ (å¦‚æ¯å¤©å‡Œæ™¨2ç‚¹)
    Backend->>GitHub: POST /repos/:repo/actions/workflows/:id/dispatches
    
    GitHub->>Action: å¯åŠ¨ Workflow
    Action->>Action: è¯»å–æ¨¡æ¿å’Œé…ç½®
    Action->>AI: è°ƒç”¨ AI ç”Ÿæˆæ–‡ç« 
    AI-->>Action: è¿”å›æ–‡ç« å†…å®¹
    
    loop å¤„ç†å›¾ç‰‡å ä½ç¬¦
        Action->>Action: è§£æ IMAGE_SEARCH å ä½ç¬¦
        Action->>ImageAPI: æœç´¢å›¾ç‰‡
        ImageAPI-->>Action: è¿”å›å›¾ç‰‡åˆ—è¡¨
        Action->>Storage: ä¸‹è½½å¹¶ä¸Šä¼ å›¾ç‰‡
        Storage-->>Action: è¿”å› CDN URL
        Action->>Action: æ›¿æ¢å ä½ç¬¦
    end
    
    Action->>GitHub: git commit & push
    Action->>Backend: POST /webhook (å®Œæˆå›è°ƒ)
    Backend->>Backend: æ›´æ–°ç”Ÿæˆè®°å½•
    Backend->>Admin: æ¨é€é€šçŸ¥
    Admin->>User: æ˜¾ç¤ºç”Ÿæˆç»“æœ
```

### 7.3 æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 7.3.1 GitHub é›†æˆæœåŠ¡

```mermaid
classDiagram
    class GitHubIntegrationService {
        +authorizeUser(code) AccessToken
        +forkRepository(token, repoUrl) Repository
        +setSecret(token, repo, name, value) void
        +triggerWorkflow(token, repo, workflowId, inputs) WorkflowRun
        +getWorkflowStatus(token, repo, runId) WorkflowStatus
        +getWorkflowJobs(token, repo, runId) JobInfo[]
        +cancelWorkflowRun(token, repo, runId) void
    }
    
    class GitHubOAuthService {
        -clientId: string
        -clientSecret: string
        +getAuthorizationUrl() string
        +exchangeCodeForToken(code) AccessToken
        +refreshToken(refreshToken) AccessToken
    }
    
    class GitHubSecretsService {
        +encryptSecret(publicKey, value) EncryptedValue
        +createOrUpdateSecret(repo, name, value) void
        +deleteSecret(repo, name) void
        +listSecrets(repo) Secret[]
    }
    
    class WorkflowDispatchService {
        +dispatch(repo, workflowId, ref, inputs) WorkflowRun
        +getRunStatus(repo, runId) WorkflowStatus
        +cancelRun(repo, runId) void
        +getRunLogs(repo, runId) string
    }
    
    GitHubIntegrationService --> GitHubOAuthService
    GitHubIntegrationService --> GitHubSecretsService
    GitHubIntegrationService --> WorkflowDispatchService
```

#### 7.3.2 å›¾ç‰‡æœåŠ¡æ¶æ„

```mermaid
classDiagram
    class ImageService {
        +processPlaceholders(content, variables) ProcessResult
        +searchImages(query, count) ImageResult[]
        +getFromPool(poolName, count) string[]
        +uploadToStorage(imageUrl) string
    }
    
    class ImageSearchEngine {
        <<interface>>
        +search(query, count) ImageResult[]
    }
    
    class BingImageSearch {
        -apiKey string
        +search(query, count) ImageResult[]
    }
    
    class UnsplashSearch {
        -accessKey string
        +search(query, count) ImageResult[]
    }
    
    class PixabaySearch {
        -apiKey string
        +search(query, count) ImageResult[]
    }
    
    class ImagePoolManager {
        -pools Map
        +loadFromUrl(url) void
        +loadFromJson(json) void
        +getImages(poolName, count) string[]
        +addImage(poolName, url) void
    }
    
    class StorageUploader {
        +upload(imageBuffer, fileName) string
        +getPublicUrl(key) string
    }
    
    ImageService --> ImageSearchEngine
    ImageService --> ImagePoolManager
    ImageService --> StorageUploader
    ImageSearchEngine <|.. BingImageSearch
    ImageSearchEngine <|.. UnsplashSearch
    ImageSearchEngine <|.. PixabaySearch
```

#### 7.3.3 å®šæ—¶è°ƒåº¦ä¸æ‰¹é‡ä»»åŠ¡æœåŠ¡

```mermaid
classDiagram
    class SchedulerService {
        +createSchedule(config) Schedule
        +updateSchedule(id, config) Schedule
        +deleteSchedule(id) void
        +enableSchedule(id) void
        +disableSchedule(id) void
        +getNextExecutionTime(id) DateTime
        +executeNow(id) ExecutionResult
    }
    
    class BatchTaskService {
        +createBatchTask(config) BatchTask
        +executeBatchTask(id) ExecutionResult
        +getBatchTaskStatus(id) TaskStatus
        +cancelBatchTask(id) void
        +retryFailedItems(id) ExecutionResult
    }
    
    class ScheduleConfig {
        +id: Long
        +name: string
        +cronExpression: string
        +repositoryId: Long
        +batchConfig: BatchConfig
        +enabled: boolean
        +lastExecutionTime: DateTime
        +nextExecutionTime: DateTime
    }
    
    class BatchConfig {
        +tasks: BatchTaskItem[]
        +options: BatchOptions
    }
    
    class BatchTaskItem {
        +gameName: string
        +category: string
        +template: string
        +aiProvider: string
        +customPrompt: string
        +keywords: string
        +imageEnabled: boolean
        +imageEngine: string
        +variables: Map
    }
    
    class BatchOptions {
        +defaultAiProvider: string
        +imageSearchEnabled: boolean
        +imageSearchEngine: string
        +maxConcurrent: int
        +delayBetweenTasks: int
    }
    
    class ScheduleExecutor {
        +execute(schedule) ExecutionResult
        -prepareBatchInputs(schedule) WorkflowInputs
        -triggerBatchWorkflow(inputs) WorkflowRun
        -recordExecution(result) void
    }
    
    class ExecutionLog {
        +id: Long
        +scheduleId: Long
        +batchTaskId: Long
        +startTime: DateTime
        +endTime: DateTime
        +status: ExecutionStatus
        +workflowRunId: Long
        +totalArticles: int
        +completedArticles: int
        +failedArticles: int
        +tokensUsed: int
        +errorMessage: string
    }
    
    SchedulerService --> ScheduleConfig
    SchedulerService --> ScheduleExecutor
    BatchTaskService --> BatchConfig
    BatchConfig --> BatchTaskItem
    BatchConfig --> BatchOptions
    ScheduleConfig --> BatchConfig
    ScheduleExecutor --> ExecutionLog
```

#### 7.3.4 æ‰¹é‡ç”Ÿæˆå·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†åå°
    participant Backend as åç«¯æœåŠ¡
    participant Scheduler as å®šæ—¶è°ƒåº¦å™¨
    participant GitHub as GitHub API
    participant Action as GitHub Action
    participant Webhook as Webhook å›è°ƒ

    rect rgb(240, 248, 255)
        Note over Admin,Backend: 1. åˆ›å»ºæ‰¹é‡ä»»åŠ¡
        Admin->>Backend: åˆ›å»ºæ‰¹é‡ç”Ÿæˆä»»åŠ¡ï¼ˆå¤šç¯‡æ–‡ç« é…ç½®ï¼‰
        Backend->>Backend: ä¿å­˜æ‰¹é‡é…ç½® BatchConfig
        Backend->>Admin: è¿”å›ä»»åŠ¡ ID
    end

    rect rgb(255, 248, 240)
        Note over Admin,Scheduler: 2. é…ç½®å®šæ—¶æ‰§è¡Œ
        Admin->>Backend: è®¾ç½® Cron è¡¨è¾¾å¼ï¼ˆå¦‚ 0 0 2 * * ?ï¼‰
        Backend->>Scheduler: æ³¨å†Œå®šæ—¶ä»»åŠ¡
        Scheduler-->>Admin: å®šæ—¶ä»»åŠ¡å·²åˆ›å»º
    end

    rect rgb(240, 255, 240)
        Note over Scheduler,Action: 3. å®šæ—¶è§¦å‘æ‰§è¡Œ
        Scheduler->>Scheduler: Cron æ—¶é—´åˆ°è¾¾
        Scheduler->>Backend: è§¦å‘æ‰§è¡Œ
        Backend->>GitHub: workflow_dispatchï¼ˆbatch_mode=true, batch_config=JSONï¼‰
        GitHub->>Action: å¯åŠ¨å·¥ä½œæµ
        
        loop æ¯ç¯‡æ–‡ç« ï¼ˆå¹¶è¡Œåº¦=2ï¼‰
            Action->>Action: AI ç”Ÿæˆæ–‡ç« 
            Action->>Action: å¤„ç†å›¾ç‰‡å ä½ç¬¦
            Action->>Action: æäº¤åˆ°ä»“åº“
            Action->>Webhook: å•ç¯‡å®Œæˆå›è°ƒ
            Webhook->>Backend: æ›´æ–°å•ç¯‡çŠ¶æ€
        end
        
        Action->>Webhook: æ‰¹é‡å®Œæˆæ±‡æ€»å›è°ƒ
        Webhook->>Backend: æ›´æ–°ä»»åŠ¡çŠ¶æ€
    end

    rect rgb(248, 240, 255)
        Note over Backend,Admin: 4. çŠ¶æ€åŒæ­¥
        Backend->>Admin: æ¨é€ä»»åŠ¡å®Œæˆé€šçŸ¥
        Admin->>Admin: å±•ç¤ºç”Ÿæˆç»“æœ
    end
```

#### 7.3.5 ä»»åŠ¡æ‰§è¡Œç›‘æ§æœºåˆ¶

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ç›‘æ§ GitHub Action çš„æ‰§è¡Œè¿›åº¦ï¼š

**æ–¹å¼ä¸€ï¼šWebhook å›è°ƒï¼ˆæ¨èï¼‰**

GitHub Action æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸»åŠ¨å‘åç«¯å‘é€çŠ¶æ€æ›´æ–°ï¼š

```mermaid
sequenceDiagram
    participant Action as GitHub Action
    participant Webhook as åç«¯ Webhook
    participant DB as æ•°æ®åº“
    participant WS as WebSocket

    Action->>Webhook: POST /ai-task/webhookï¼ˆå•ç¯‡å®Œæˆï¼‰
    Webhook->>Webhook: éªŒè¯ç­¾å
    Webhook->>DB: æ›´æ–° execution_items çŠ¶æ€
    Webhook->>WS: æ¨é€è¿›åº¦æ›´æ–°
    WS-->>Admin: å®æ—¶åˆ·æ–°é¡µé¢
```

**æ–¹å¼äºŒï¼šè½®è¯¢ GitHub API**

å½“ Webhook ä¸å¯ç”¨æˆ–éœ€è¦åŒæ­¥æœ€æ–°çŠ¶æ€æ—¶ï¼š

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†åå°
    participant API as åç«¯ API
    participant GitHub as GitHub API

    loop æ¯5ç§’
        Admin->>API: GET /ai-task/execution/{id}
        
        alt æ‰§è¡Œä¸­çŠ¶æ€
            API->>GitHub: GET /repos/.../actions/runs/{runId}
            GitHub-->>API: Workflow çŠ¶æ€
            API->>GitHub: GET /repos/.../actions/runs/{runId}/jobs
            GitHub-->>API: Jobs çŠ¶æ€åˆ—è¡¨
            API->>API: æ›´æ–°æœ¬åœ°çŠ¶æ€
        end
        
        API-->>Admin: è¿”å›æ‰§è¡Œè¯¦æƒ…
    end
```

**çŠ¶æ€åŒæ­¥é€»è¾‘**

| GitHub Workflow çŠ¶æ€ | æœ¬åœ°ä»»åŠ¡çŠ¶æ€ | è¯´æ˜ |
|---------------------|-------------|------|
| `queued` | å·²è§¦å‘(1) | ç­‰å¾…æ‰§è¡Œ |
| `in_progress` | æ‰§è¡Œä¸­(2) | æ­£åœ¨æ‰§è¡Œ |
| `completed` + `success` | å·²å®Œæˆ(3) | å…¨éƒ¨æˆåŠŸ |
| `completed` + `failure` | éƒ¨åˆ†å¤±è´¥(3)/å…¨éƒ¨å¤±è´¥(4) | æ ¹æ®å­ä»»åŠ¡åˆ¤æ–­ |
| `cancelled` | å·²å–æ¶ˆ(5) | ç”¨æˆ·å–æ¶ˆ |

**æ‰§è¡Œè¯¦æƒ…è§£æ**

é€šè¿‡ GitHub API è·å– Jobs ä¿¡æ¯è§£ææ¯ç¯‡æ–‡ç« çŠ¶æ€ï¼š

```java
// ä¼ªä»£ç ï¼šè§£æ Workflow Jobs
List<Job> jobs = githubApi.getWorkflowJobs(runId);

for (Job job : jobs) {
    // Job name æ ¼å¼: "generate (å‰‘æ¥, xianxia, game-intro)"
    if (job.getName().startsWith("generate")) {
        String gameName = parseGameName(job.getName());
        ExecutionItem item = findByGameName(gameName);
        
        item.setStatus(mapJobStatus(job.getStatus(), job.getConclusion()));
        if (job.getCompletedAt() != null) {
            item.setCompletedAt(job.getCompletedAt());
        }
    }
}
```

### 7.4 å›¾ç‰‡å ä½ç¬¦è¯­æ³•

| å ä½ç¬¦æ ¼å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|-----------|------|------|
| `{IMAGE_SEARCH:å…³é”®è¯}` | æœç´¢å¹¶æ’å…¥ 1 å¼ å›¾ç‰‡ | `{IMAGE_SEARCH:å‰‘æ¥æ¸¸æˆæˆªå›¾}` |
| `{IMAGE_SEARCH:å…³é”®è¯:æ•°é‡}` | æœç´¢å¹¶éšæœºé€‰å–å¤šå¼  | `{IMAGE_SEARCH:ä»™ä¾ æ¸¸æˆ:3}` |
| `{IMAGE_POOL:åˆ†ç±»}` | ä»å›¾ç‰‡æ± éšæœºé€‰å– 1 å¼  | `{IMAGE_POOL:banner}` |
| `{IMAGE_POOL:åˆ†ç±»:æ•°é‡}` | ä»å›¾ç‰‡æ± é€‰å–å¤šå¼  | `{IMAGE_POOL:screenshot:2}` |
| `{IMAGE:URL}` | ä½¿ç”¨å›ºå®š URL | `{IMAGE:https://cdn.example.com/logo.png}` |

### 7.5 æ¨¡æ¿ç¤ºä¾‹ï¼ˆå«å›¾ç‰‡ï¼‰

```text
---
title: "{gameName}ç ´è§£ç‰ˆä¸‹è½½"
description: "{gameName}ç ´è§£ç‰ˆï¼Œæ— é™å…ƒå®ï¼Œæ»¡VIPç‰¹æƒ"
cover: "{IMAGE_POOL:banner}"
---

# {gameName}ç ´è§£ç‰ˆä¸‹è½½

{IMAGE_SEARCH:{gameName}æ¸¸æˆæˆªå›¾}

## æ¸¸æˆç®€ä»‹

{AI_GENERATE:è¯·ä¸º{gameName}å†™ä¸€æ®µ200å­—çš„æ¸¸æˆç®€ä»‹}

## æ¸¸æˆæˆªå›¾

{IMAGE_SEARCH:{gameName}:3}

## æ¸¸æˆç‰¹è‰²

{AI_GENERATE:è¯·åˆ—å‡º{gameName}çš„5ä¸ªä¸»è¦ç‰¹è‰²}

## ä¸‹è½½è¯´æ˜

{IMAGE_POOL:download-guide}

ç«‹å³ä¸‹è½½ä½“éªŒï¼
```

### 7.6 å®‰å…¨è®¾è®¡

#### 7.6.1 API Key å®‰å…¨

- åç«¯åŠ å¯†å­˜å‚¨ï¼ˆAES-256ï¼‰
- ä»…åŒæ­¥åˆ°ç”¨æˆ·è‡ªå·± Fork çš„ä»“åº“
- GitHub Secrets åŠ å¯†å­˜å‚¨
- ä¸åœ¨æ—¥å¿—ä¸­æ‰“å°

#### 7.6.2 Webhook éªŒè¯

```typescript
// Webhook ç­¾åéªŒè¯
const signature = crypto
  .createHmac('sha256', webhookSecret)
  .update(JSON.stringify(payload))
  .digest('hex');

if (signature !== request.headers['x-webhook-signature']) {
  throw new Error('Invalid webhook signature');
}
```